<?xml version='1.0' encoding='UTF-8'?>
<simple-page xmlns="http://n2oapp.net/framework/config/schema/page-3.0"
             name="Создание записи о синхронизации">
    <form name="Справочник" query-id="syncEntry" object-id="syncEntry">
        <fields>
            <set field-label-location="left">
                <select id="source" label="Источник "
                        query-id="syncEntrySourceList" label-field-id="name" search="false"
                        label-class="w-50" required="true"/>

                <!--<input-text id="refBook" label="Справочник "-->
                <!--            required="true" label-class="w-50">-->
                <!--    <dependencies>-->
                <!--        <enabling on="source">-->
                <!--            typeof source != 'undefined' || source?.id != null-->
                <!--        </enabling>-->
                <!--    </dependencies>-->

                <!--    &lt;!&ndash;<validations white-list="validateRefBook"/>&ndash;&gt;-->
                <!--    <validations>-->
                <!--        &lt;!&ndash;<condition id="checkRefBook" severity="warning"&ndash;&gt;-->
                <!--        &lt;!&ndash;           message="Запись с oid уже существует">&ndash;&gt;-->
                <!--        &lt;!&ndash;    typeof refBook != 'undefined' &amp;&amp; refBook != null &amp;&amp;&ndash;&gt;-->
                <!--        &lt;!&ndash;    refBook !== '1.2.643.5.1.13.13.11.1005'&ndash;&gt;-->
                <!--        &lt;!&ndash;</condition>&ndash;&gt;-->

                <!--        <constraint id="validateRefBook" severity="danger"-->
                <!--                    result="#this == null" message="{result}"-->
                <!--                    side="client,server" server-moment="before-operation">-->
                <!--            <invocation>-->
                <!--                <rest method="GET">-->
                <!--                    ${rdm.sync.admin.backend.path}/sync/admin/refbooks/validate/{source}/{code}-->
                <!--                </rest>-->
                <!--            </invocation>-->
                <!--            <in>-->
                <!--                <field id="source.id" mapping="['source']" domain="string"/>-->
                <!--                <field id="refBook" mapping="['code']" domain="string"/>-->
                <!--            </in>-->
                <!--            <out>-->
                <!--                <field id="result" mapping="(#this)" domain="string"/>-->
                <!--            </out>-->
                <!--        </constraint>-->
                <!--    </validations>-->
                <!--</input-text>-->

                <input-select id="refBook" label="Справочник "
                              query-id="syncSourceRefBookList" label-field-id="displayName"
                              label-class="w-50" required="true">
                    <pre-filters>
                        <eq field-id="sourceCode" value="{source.id}"/>
                        <eq field-id="hasEntry" value="false"/>
                    </pre-filters>

                    <dependencies>
                        <enabling on="source">
                            (typeof source != 'undefined' &amp;&amp; source?.id != null)
                        </enabling>
                    </dependencies>

                    <!-- NB: Валидация отключена до исправления NNO-6951 -->
                    <!--<validations white-list="validateRefBook"/>-->
                    <!--<validations>-->
                    <!--    &lt;!&ndash; Проверочная валидация &ndash;&gt;-->
                    <!--    &lt;!&ndash;<condition id="checkRefBook" severity="warning"&ndash;&gt;-->
                    <!--    &lt;!&ndash;           message="Запись с oid уже существует">&ndash;&gt;-->
                    <!--    &lt;!&ndash;    typeof refBook != 'undefined' &amp;&amp; refBook != null &amp;&amp;&ndash;&gt;-->
                    <!--    &lt;!&ndash;    refBook !== '1.2.643.5.1.13.13.11.1005'&ndash;&gt;-->
                    <!--    &lt;!&ndash;</condition>&ndash;&gt;-->

                    <!--    <constraint id="validateRefBook" severity="danger"-->
                    <!--                result="#this == null" message="{result}"-->
                    <!--                side="client,server" server-moment="before-operation">-->
                    <!--        <invocation>-->
                    <!--            <rest method="GET">-->
                    <!--                ${rdm.sync.admin.backend.path}/sync/admin/refbooks/validate/{sourceCode}/{code}-->
                    <!--            </rest>-->
                    <!--        </invocation>-->
                    <!--        <in>-->
                    <!--            <field id="source.id" mapping="sourceCode" domain="string"/>-->
                    <!--            <field id="refBook.id" mapping="code" domain="string"/>-->
                    <!--        </in>-->
                    <!--        <out>-->
                    <!--            <field id="result" mapping="(#this)" domain="string"/>-->
                    <!--        </out>-->
                    <!--    </constraint>-->
                    <!--</validations>-->
                </input-select>

                <output-text id="refBookName" no-label="true" no-label-block="true" enabled="false">
                <!--<output-text id="refBokName" label="" no-label="true"-->
                <!--             label-class="w-50" enabled="false">-->
                    <dependencies>
                        <visibility on="refBook">
                            (typeof refBook != 'undefined' &amp;&amp; refBook?.id != null)
                        </visibility>
                        <set-value on="refBook">
                            if (typeof refBook != 'undefined' &amp;&amp; refBook?.id != null)
                                return refBook.name;
                            else
                                return null;
                        </set-value>
                    </dependencies>
                </output-text>

                <checkbox id="autoUpdatable" label="Автоматически обновлять" default-value="true" label-class="w-50">
                    <dependencies>
                        <enabling on="refBook">
                            (typeof refBook != 'undefined' &amp;&amp; refBook?.id != null)
                        </enabling>
                    </dependencies>
                </checkbox>

                <checkbox id="versioned" label="Поддерживать версионность" default-value="false" label-class="w-50">
                    <dependencies>
                        <enabling on="refBook">
                            (typeof refBook != 'undefined' &amp;&amp; refBook?.id != null)
                        </enabling>
                    </dependencies>
                </checkbox>

                <output-text id="lastVersion" label="Последняя версия "
                             required="true" label-class="w-50">
                    <dependencies>
                        <set-value on="refBook">
                            if (typeof refBook != 'undefined' &amp;&amp; refBook?.id != null) {
                                return refBook.version;
                            } else
                                return null;
                        </set-value>
                    </dependencies>
                </output-text>
                <!--return { 'id': refBook.versionId, 'name': refBook.version };-->

                <input-select id="startVersion" label="Загрузить с версии "
                              query-id="syncSourceVersionList" label-field-id="displayName"
                              required="true" label-class="w-50">
                    <pre-filters>
                        <eq field-id="sourceCode" value="{source.id}"/>
                        <eq field-id="code" value="{refBook.id}"/>
                    </pre-filters>

                    <dependencies>
                        <set-value on="refBook,versioned">
                            if ((typeof refBook != 'undefined' &amp;&amp; refBook?.id != null) &amp;&amp;
                                (typeof versioned == 'undefined' || !versioned))
                                return { 'id': refBook.versionId, 'displayName': refBook.version };
                            else
                                return;
                        </set-value>
                        <enabling on="refBook,versioned">
                            (typeof refBook != 'undefined' &amp;&amp; refBook?.id != null) &amp;&amp;
                            (typeof versioned != 'undefined' &amp;&amp; versioned)
                        </enabling>
                    </dependencies>
                </input-select>
            </set>
        </fields>

        <toolbar place="bottomRight">
            <button id="createMapping" label="Настроить поля">
                    <show-modal page-id="syncMapping"
                                page-name="Настройка полей справочника"
                                modal-size="xl" scrollable="true"
                                route="/mapping/create">
                        <query-param name="sourceCode" value="{source.id}"/>
                        <query-param name="code" value="{refBook.id}"/>
                        <query-param name="name" value="{refBookName}"/>
                        <query-param name="version" value="{startVersion.id}"/>
                        <query-param name="versioned" value="{versioned}"/>
                        <query-param name="autoUpdatable" value="{autoUpdatable}"/>
                        <query-param name="actionType" value="create"/>
                    </show-modal>
            </button>

            <button id="cancel" label="Отмена">
                <close/>
            </button>

        </toolbar>
    </form>
</simple-page>
